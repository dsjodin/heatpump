version: '3.8'

# Docker Compose for EXTERNAL MQTT Broker
# Use this when you already have an MQTT broker running
# 
# To use:
# 1. Rename this file to docker-compose.yml (backup the original)
# 2. Update config.yaml with your MQTT broker IP/hostname
# 3. Deploy: docker-compose up -d

services:
  # InfluxDB Time-Series Database
  influxdb:
    image: influxdb:2.7
    container_name: thermia-influxdb
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123456
      - DOCKER_INFLUXDB_INIT_ORG=thermia
      - DOCKER_INFLUXDB_INIT_BUCKET=heatpump
      - DOCKER_INFLUXDB_INIT_RETENTION=90d
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=thermia-super-secret-token
    volumes:
      - influxdb_data:/var/lib/influxdb2
      - influxdb_config:/etc/influxdb2
    networks:
      - thermia-net

  # Data Collector Service
  collector:
    build:
      context: .
      dockerfile: collector/Dockerfile
    container_name: thermia-collector
    restart: unless-stopped
    depends_on:
      - influxdb
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=thermia-super-secret-token
      - INFLUXDB_ORG=thermia
      - INFLUXDB_BUCKET=heatpump
    # Use host network if MQTT broker is on same machine
    # network_mode: host
    networks:
      - thermia-net

  # Heat Pump Simulator (for testing UI with different manufacturers)
  # Enable in config.yaml: simulator.enabled = true
  simulator:
    build:
      context: .
      dockerfile: simulator/Dockerfile
    container_name: thermia-simulator
    restart: unless-stopped
    depends_on:
      - influxdb
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - CONFIG_PATH=/app/config.yaml
    networks:
      - thermia-net
    profiles:
      - simulator  # Only starts when: docker-compose --profile simulator up

  # Web Dashboard
  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: thermia-dashboard
    restart: unless-stopped
    ports:
      - "8050:8050"
    depends_on:
      - influxdb
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=thermia-super-secret-token
      - INFLUXDB_ORG=thermia
      - INFLUXDB_BUCKET=heatpump
    networks:
      - thermia-net

networks:
  thermia-net:
    driver: bridge

volumes:
  influxdb_data:
  influxdb_config:
